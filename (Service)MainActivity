package com.example.tempaturedisp;

import android.app.Activity;
import android.app.Fragment;
import android.content.Context;
import android.hardware.Sensor;
import android.hardware.SensorEvent;
import android.hardware.SensorEventListener;
import android.hardware.SensorManager;
import android.net.wifi.WifiInfo;
import android.net.wifi.WifiManager;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.MenuItem;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.RelativeLayout;
import android.widget.TextView;

import com.chinasofti.service.ServerStatus;
import com.chinasofti.service.ServiceCenter;




public class MainActivity extends Activity
{
private static MainActivity mainActivity;
	
	public static MainActivity getMainActivity()
	{
		return mainActivity;
	}
	
	public void statusChanged(ServerStatus status)
	{
		PlaceholderFragment.getMainFragment().statusChanged(status);
	}
	public void receiveClientMessage(String message)
	{
		PlaceholderFragment.getMainFragment().receiveClientMessage(message);
	}
	public void clientLogined(String clientIpPort)
	{
		PlaceholderFragment.getMainFragment().clientLogined(clientIpPort);
	}
	public void clientLogout(String clientIpPort)
	{
		PlaceholderFragment.getMainFragment().clientLogout(clientIpPort);
	}
	
	private String getWifiIpAddress()
	{
		WifiManager wifiManager = (WifiManager)getSystemService(Context.WIFI_SERVICE);    
        WifiInfo wifiInfo = wifiManager.getConnectionInfo();    
        int ipAddress = wifiInfo.getIpAddress();   
        //Log.d("showip", "int ip "+ipAddress);  
        if(ipAddress==0)return null;  
        return ((ipAddress & 0xff)+"."+(ipAddress>>8 & 0xff)+"."  
                +(ipAddress>>16 & 0xff)+"."+(ipAddress>>24 & 0xff));
	}
	
	protected void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_main);
		mainActivity = this;
		if (savedInstanceState == null)
		{
			getFragmentManager().beginTransaction()
					.add(R.id.container, new PlaceholderFragment()).commit();
		}
	}

	public boolean onCreateOptionsMenu(Menu menu)
	{
		// Inflate the menu; this adds items to the action bar if it is present.
		getMenuInflater().inflate(R.menu.main, menu);
		return true;
	}

	public boolean onOptionsItemSelected(MenuItem item)
	{
		// Handle action bar item clicks here. The action bar will
		// automatically handle clicks on the Home/Up button, so long
		// as you specify a parent activity in AndroidManifest.xml.
		int id = item.getItemId();
		if (id == R.id.action_settings)
		{
			return true;
		}
		return super.onOptionsItemSelected(item);
	}

	
	
	
	/**
	 * A placeholder fragment containing a simple view.
	 */
	
	public static class PlaceholderFragment extends Fragment
	{
		private float ballX = 550;
		private float ballY = 1000;
		private float ballZ = 0;
		
		
		private static PlaceholderFragment mainFragment;
		private Handler handlerMessage = null;
		private MainActivity mainActivity = null;
		
		public static PlaceholderFragment getMainFragment()
		{
			return mainFragment;
		}
		
		public PlaceholderFragment()
		{
			mainFragment = this;
		}

		
		@Override
		public void onAttach(Activity activity) {
			// TODO Auto-generated method stub
			super.onAttach(activity);
			
			mainActivity = (MainActivity) activity;
		}
		
		public void receiveClientMessage(String message)
		{
			Message msg = new Message();
			msg.what = R.id.tvReceivedMessage;
			msg.obj = message;
			handlerMessage.sendMessage(msg);
		}
		
		public void statusChanged(ServerStatus status)
		{
			switch(status)
			{
			case STARTED:
			{
				Message msg = new Message();
				//msg.what = R.id.serverStatus;
				msg.obj = "启动成功，请点击停止按钮停止监听！";
				handlerMessage.sendMessage(msg);
			}
				break;
			case STOPPED:
			{
				Message msg = new Message();
				//msg.what = R.id.serverStatus;
				msg.obj = "已停止服务， 请点击启动按钮开始服务！";
				handlerMessage.sendMessage(msg);
			}
				break;
			case ERROR:
			{
				Message msg = new Message();
				//msg.what = R.id.serverStatus;
				msg.obj = "发生错误，请修改相应配置后重试！";
				handlerMessage.sendMessage(msg);
			}
				break;
			}
		}
		
		public void clientLogined(String clientIpPort)
		{
			Message msg1 = new Message();
			msg1.what = R.id.tvClientStatus;
			msg1.obj = "客户端已连接！";
			handlerMessage.sendMessage(msg1);
			
			Message msg2 = new Message();
			msg2.what = R.id.tvClientIP;
			msg2.obj = clientIpPort;
			handlerMessage.sendMessage(msg2);
		}
		
		public void clientLogout(String clientIpPort)
		{
			Message msg1 = new Message();
			msg1.what = R.id.tvClientStatus;
			msg1.obj = "客户端已断开！";
			handlerMessage.sendMessage(msg1);
			
			Message msg2 = new Message();
			msg2.what = R.id.tvClientIP;
			msg2.obj = "客户端已断开！";
			handlerMessage.sendMessage(msg2);
		}
		
		
		@Override
		public View onCreateView(LayoutInflater inflater, ViewGroup container,
				Bundle savedInstanceState)
		{
			View rootView = inflater.inflate(R.layout.fragment_main, container, false);
			
			
			final TextView tvServerIP = (TextView)rootView.findViewById(R.id.tvServerIP);
			final EditText etServerPort = (EditText)rootView.findViewById(R.id.etServerPort);
			final Button buttonStart = (Button)rootView.findViewById(R.id.buttonStart);
			final Button buttonStop = (Button)rootView.findViewById(R.id.buttonStop);
			final Button buttonSentMessage = (Button)rootView.findViewById(R.id.buttonSentMessage);
			final EditText etMessage = (EditText)rootView.findViewById(R.id.etMessage);
			final TextView tvReceivedMessage = (TextView)rootView.findViewById(R.id.tvReceivedMessage);
			final TextView tvClientStatus = (TextView)rootView.findViewById(R.id.tvClientStatus);
			final TextView tvClientIP = (TextView)rootView.findViewById(R.id.tvClientIP);
			String ip = mainActivity.getWifiIpAddress();
			
			
			final ImageView imBall = (ImageView)rootView.findViewById(R.id.imageBall);
			
			
			if(ip == null || ip.isEmpty())
			{
				tvServerIP.setText("no net!");
			}
			else
			{
				tvServerIP.setText(ip);
			}
			
			buttonStart.setOnClickListener(new OnClickListener()
			{
				
				@Override
				public void onClick(View arg0)
				{
					// TODO Auto-generated method stub
					String strPort = etServerPort.getText().toString();
					
					int port = Integer.parseInt(strPort);
					if ( ServiceCenter.getServiceCenter().startServer(port)  == true)
					{
						buttonStart.setEnabled(false);
						buttonStop.setEnabled(true);
					}
				
				}
			});
			
			
			buttonStop.setOnClickListener(new OnClickListener()
			{
				
				@Override
				public void onClick(View arg0)
				{
					// TODO Auto-generated method stub
					 ServiceCenter.getServiceCenter().safeCloseServer();
					 
					 clientLogout("");  //关闭客户端
					 
					 buttonStart.setEnabled(true);
					 buttonStop.setEnabled(false);
				}
			});
			
			
			buttonSentMessage.setOnClickListener(new OnClickListener()
			{
				
				@Override
				public void onClick(View arg0)
				{
					// TODO Auto-generated method stub
					String message = etMessage.getText().toString();
					ServiceCenter.getServiceCenter().sendCommandAndData("SEND_MESSAGE:" + message);	
				}
			});
			
			
			
			
			
			
		
						
			//final MainView mainview = (MainView)rootView.findViewById(R.id.mainView1);
			
			//获得服务
			SensorManager seManager = (SensorManager)getActivity().getSystemService(Context.SENSOR_SERVICE);
			Sensor sensor = seManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER);
			//响应函数
			SensorEventListener sel = new SensorEventListener()
			{
				private void changeBallPosition(ImageView ball, float offsetX, float offsetY, float offsetZ, float rate)
				{
					ballX -= offsetX * rate;
					ballY += offsetY * rate;
					RelativeLayout.LayoutParams lp = new RelativeLayout.LayoutParams(50, 50);
					lp.setMargins((int)ballX, (int)ballY, 0, 0);
					ball.setLayoutParams(lp);
				}
				
				
				@Override
				public void onSensorChanged(SensorEvent arg0)
				{
					// TODO Auto-generated method stub
					float x = arg0.values[0];
					float y = arg0.values[1];
					float z = arg0.values[2];
					//changeBallPosition(x, y, 1);
					//传感器的数据获得后，需要通过网络发送给客户端
					String send_msg = "CHANGE_TEMPATURE:" + String.valueOf((int)x) + String.valueOf((int)y) + String.valueOf((int)z);
					ServiceCenter.getServiceCenter().sendTempatureData(send_msg);
					
					if((int)ballX <= 43 && x > 0 || (int)ballX >= 995 && x < 0)
					{
						x = 0;
					}
					if((int)ballY <= 1000 && y < 0 || (int)ballY >= 1900 && y > 0)
					{
						y = 0;
					}
					
					
					changeBallPosition(imBall, x, y, z, 2.0f);
					
				}
				
				@Override
				public void onAccuracyChanged(Sensor arg0, int arg1)
				{
					// TODO Auto-generated method stub
					
				}
			};
			
			seManager.registerListener(sel, sensor, SensorManager.SENSOR_DELAY_GAME);
			
			
			//按键
			//Button button_connect = (Button)rootView.findViewById(R.id.button_connect);
			//Button button_get_tempature = (Button)rootView.findViewById(R.id.button_get_tempature);

			
//			button_connect.setOnClickListener(new OnClickListener()
//			{
//				public void onClick(View arg0)
//				{
//					
//				}
//			});
			
			
			
			//button_get_tempature.setOnClickListener(new OnClickListener()
			//{
			//	public void onClick(View arg0)
			//	{
					//mainview.get_tempature();
			//	}
			//});
			
			
			handlerMessage = new Handler(){
				@Override
				public void handleMessage(Message msg) {
					// TODO Auto-generated method stub
					switch(msg.what)
					{
					case R.id.tvReceivedMessage:
						tvReceivedMessage.setText(msg.obj.toString());    //更新界面
						break;
					case R.id.tvClientIP:
						tvClientIP.setText(msg.obj.toString());
					}
				}
			};
			
			return rootView;
		}
	}
}
